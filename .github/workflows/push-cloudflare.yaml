name: Build

on:
  push:
    branches: [main, uat, release*]
  workflow_dispatch:

jobs:
  build:
    name: Run production build
    runs-on: ubuntu-latest
    env:
      # Pin tool versions to avoid upstream updates breaking CI
      WORKER_BUILD_VERSION: "0.7.1"
      WRANGLER_VERSION: "4.54.0"
      # Web Vault frontend (bw_web_builds) version tag (default pinned; override via GitHub Actions Variables)
      # - Set repository variable BW_WEB_VERSION (e.g. v2025.12.0) to override
      # - Set to "latest" to follow the latest bw_web_builds release
      BW_WEB_VERSION: ${{ vars.BW_WEB_VERSION || 'v2025.12.0' }}

      # Required for wrangler
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js (for npx wrangler)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Rust toolchain (from rust-toolchain.toml)
        run: |
          set -euo pipefail
          TOOLCHAIN="$(sed -n 's/^channel[[:space:]]*=[[:space:]]*"\([^"]*\)".*$/\1/p' rust-toolchain.toml | head -n 1)"
          if [ -z "$TOOLCHAIN" ]; then
            echo "âŒ Failed to read toolchain channel from rust-toolchain.toml" >&2
            exit 1
          fi
          echo "Using Rust toolchain: $TOOLCHAIN"
          echo "RUSTUP_TOOLCHAIN=$TOOLCHAIN" >> "$GITHUB_ENV"
          rustup toolchain install "$TOOLCHAIN" --profile minimal --component rustfmt --component clippy --target wasm32-unknown-unknown

      - name: Install lld
        run: sudo apt install -y lld clang gcc llvm

      - name: Install worker-build
        run: |
          set -euo pipefail
          if command -v worker-build &> /dev/null; then
            echo "worker-build already installed: $(worker-build --version || true)"
          fi
          cargo install --locked -q worker-build --version "${WORKER_BUILD_VERSION}"

      - name: Download and extract frontend (bw_web_builds)
        run: |
          set -euo pipefail
          TAG="${BW_WEB_VERSION}"
          if [ "${TAG}" = "latest" ]; then
            TAG="$(curl -s https://api.github.com/repos/dani-garcia/bw_web_builds/releases/latest | jq -r .tag_name)"
          fi

          echo "ğŸ“¦ Downloading frontend version: ${TAG}"

          # Download the web vault release
          wget -q "https://github.com/dani-garcia/bw_web_builds/releases/download/${TAG}/bw_web_${TAG}.tar.gz"

          # Extract to public/web-vault
          tar -xzf "bw_web_${TAG}.tar.gz" -C public/

          # bw_web_builds extracts into a web-vault folder (expected)
          if [ ! -d "public/web-vault" ]; then
            echo "âŒ Expected ./public/web-vault after extracting bw_web_builds" >&2
            ls -la public/ | head -50 || true
            exit 1
          fi

          # Remove large source maps to satisfy Cloudflare static asset per-file limits
          find public/web-vault -type f -name '*.map' -delete

          # Cleanup
          rm -f "bw_web_${TAG}.tar.gz"

          echo "âœ… Frontend files extracted to ./public/web-vault"
          ls -la public/web-vault/ | head -20

      - name: Apply web vault overrides (vaultwarden.css)
        run: |
          bash scripts/apply-web-vault-overrides.sh public/web-vault

      - name: Replace D1_DATABASE_ID in wrangler.toml
        run: sed -i "s/\${D1_DATABASE_ID}/${{ secrets.D1_DATABASE_ID }}/g" wrangler.toml

      - name: Enable R2 binding when R2_NAME is provided
        env:
          R2_NAME: ${{ secrets.R2_NAME }}
        run: |
          if [ -n "$R2_NAME" ]; then
            echo "ğŸ”§ Enabling R2 bucket binding"
            {
              echo ''
              echo '[[r2_buckets]]'
              echo 'binding = "ATTACHMENTS_BUCKET"'
              echo "bucket_name = \"${R2_NAME}\""
            } >> wrangler.toml
          else
            echo "â­ï¸ R2_NAME not set, skipping R2 binding"
          fi

      # è·³è¿‡æ•°æ®åº“åˆå§‹åŒ–å’Œè¿ç§»æ­¥éª¤
      - name: Skip database setup (tables already exist)
        run: echo "â­ï¸ Skipping database setup - tables already exist"

      - uses: cloudflare/wrangler-action@v3
        id: cf
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: ${{ env.WRANGLER_VERSION }}
          packageManager: npm
          command: deploy
